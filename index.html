<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>متجر السعودية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="تصفح أحدث المنتجات وتسوق الآن مع شحن داخل السعودية.">
  <link rel="canonical" href="https://sherow1982.github.io/saudi-matjar.arabsad.com/">

  <!-- تحسينات أسلوبية -->
  <style>
    :root{
      --brand:#0b57d0;
      --bg:#f9fafb;
      --text:#111827;
      --muted:#6b7280;
      --card:#ffffff;
      --border:#e5e7eb;
      --accent:#0b8457;
      --nav-bg:#ffffff;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
    }

    /* شريط الروابط أعلى الصفحة */
    .top-nav{
      position:sticky; /* يبقى مثبتاً عند التمرير */
      top:0;
      z-index:1000;
      background:var(--nav-bg);
      border-bottom:1px solid var(--border);
      backdrop-filter:saturate(150%) blur(4px);
    }
    .top-nav .wrap{
      max-width:1200px;
      margin-inline:auto;
      padding:10px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .brand{
      font-weight:700;
      color:var(--brand);
      margin-inline-end:8px;
      white-space:nowrap;
    }
    .top-nav ul{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .top-nav a{
      text-decoration:none;
      color:var(--brand);
      padding:6px 10px;
      border-radius:8px;
      display:inline-block;
      transition:background .15s ease,color .15s ease;
    }
    .top-nav a:hover{background:#eef3fd}

    /* رأس الصفحة والعناصر الرئيسية */
    .header{
      max-width:1200px;
      margin:14px auto 0;
      padding:0 16px;
      color:var(--brand);
      font-weight:800;
      text-align:center;
      letter-spacing:.2px;
    }

    #search{
      width:min(100%, 1200px);
      display:block;
      margin:12px auto 10px;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-weight:600;
      direction:rtl;
    }

    /* شبكة المنتجات */
    #products{
      max-width:1200px;
      margin-inline:auto;
      padding:12px 16px 120px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:14px;
    }

    .card{
      background:var(--card);
      padding:12px;
      border-radius:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.07);
      transition:transform .15s ease, box-shadow .15s ease;
      text-align:center;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:320px;
      border:1px solid var(--border);
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(0,0,0,0.08);
    }

    .product-image{
      width:100%;
      height:190px;
      object-fit:contain;
      cursor:pointer;
      margin-bottom:8px;
      background:#fff;
      border:1px solid #eee;
      border-radius:10px;
    }

    .title{
      font-weight:700;
      margin:.4rem 0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      text-overflow:ellipsis;
      min-height:48px;
      line-height:1.3;
    }

    .price{
      font-weight:800;
      color:var(--accent);
      font-size:1rem;
    }

    .shop-btn{
      font-weight:700;
      padding:10px;
      border-radius:10px;
      background:var(--brand);
      color:#fff;
      text-decoration:none;
      text-align:center;
      display:block;
      margin-top:auto;
      height:42px;
      line-height:42px;
      transition:opacity .15s ease;
    }
    .shop-btn:hover{opacity:.9}

    .badge{
      background:#FFD700;
      color:#000;
      font-weight:700;
      padding:4px 8px;
      margin-top:10px;
      display:inline-block;
      border-radius:8px;
      font-size:.8rem;
    }

    .loading-msg,.empty{
      grid-column:1/-1;
      text-align:center;
      color:var(--muted);
      font-weight:700;
      margin:20px 0;
    }

    /* زر واتساب ثابت */
    .whatsapp-btn{
      position:fixed;
      bottom:20px;
      inset-inline-end:20px;
      background:#25D366;
      color:#fff;
      padding:12px 16px;
      font-weight:700;
      border-radius:50px;
      z-index:9999;
      text-align:center;
      text-decoration:none;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
    }

    /* تحسينات لمراعاة الهيدر المثبّت */
    main{scroll-margin-top:72px}

    /* تجاوب */
    @media (max-width:480px){
      .top-nav .wrap{gap:8px}
      .top-nav a{padding:6px 8px}
      #products{grid-template-columns:repeat(auto-fit,minmax(170px,1fr))}
      .product-image{height:170px}
    }
  </style>
</head>
<body>

  <!-- شريط التنقل أعلى كل شيء -->
  <nav class="top-nav" aria-label="روابط الصفحات">
    <div class="wrap">
      <span class="brand">روابط مهمة:</span>
      <ul>
        <li><a href="/pages/shipping-policy.html">سياسة الشحن</a></li>
        <li><a href="/pages/who-we-are.html">من نحن</a></li>
        <li><a href="/pages/terms-and-conditions.html">شروط الاستخدام</a></li>
        <li><a href="/pages/about-our-store.html">لمحة ونبذة عن متجرنا</a></li>
        <li><a href="/pages/social-media-pages.html">صفحات التواصل الاجتماعي</a></li>
        <li><a href="/pages/privacy-policy.html">سياسات الخصوصية</a></li>
        <li><a href="/pages/contact-us.html">اتصل بنا</a></li>
        <li><a href="/pages/refund-policy.html">سياسة الاستبدال والاسترجاع</a></li>
      </ul>
    </div>
  </nav>

  <!-- عنوان -->
  <h1 class="header">متجر السعودية</h1>

  <!-- مربع البحث -->
  <input type="text" id="search" placeholder="ابحث عن منتج...">

  <!-- شبكة المنتجات -->
  <main id="main">
    <section id="products">
      <p class="loading-msg">جارٍ تحميل المنتجات...</p>
    </section>
  </main>

  <!-- زر واتساب -->
  <a id="whatsappBtn" href="https://wa.me/201110760081" target="_blank" rel="noopener noreferrer" class="whatsapp-btn" aria-label="تواصل واتساب">راسلنا واتساب الآن</a>

  <!-- السكربت -->
  <script>
    // إعدادات
    const FEED_URL = "https://api.easy-orders.net/api/v1/products/feed/37ad236e4a0f46e29792dd52978832bc/channel/google";
    const SITE_BASE = "https://sherow1982.github.io/saudi-matjar.arabsad.com";
    const ITEMS_PER_LOAD = 12;

    // حالة
    let productsData = [], filteredData = [], currentIndex = 0;

    // أدوات
    function makeSlug(s){
      s = (s || "").trim().toLowerCase();
      s = s.replace(/[^a-z0-9\-]+/g,"-");
      s = s.replace(/\-+/g,"-").replace(/^\-|\-$/g,"");
      return s || "item";
    }

    function currencySAR(v){
      if(!v || !isFinite(v)) return "—";
      try{
        return new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR',maximumFractionDigits:2}).format(v);
      }catch(_){
        return v.toFixed(2) + " ر.س";
      }
    }

    async function fetchFeed(){
      const res = await fetch(FEED_URL, { headers: { 'Accept':'application/xml,text/xml;q=0.9,*/*;q=0.8' }});
      if(!res.ok) throw new Error("Failed to fetch feed: "+res.status);
      const text = await res.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");
      if(xml.querySelector("parsererror")) throw new Error("XML parse error");
      const items = xml.querySelectorAll("item");
      const data = [];
      items.forEach(item => {
        const title = item.querySelector("title")?.textContent?.trim() || "منتج بدون اسم";
        const gid = item.querySelector("g\\:id, id")?.textContent?.trim() || title;
        const slug = makeSlug(gid);
        const pageUrl = SITE_BASE + "/product/" + slug + "/";
        const image = item.querySelector("g\\:image_link, image_link, image")?.textContent?.trim() || "";
        const priceRaw = item.querySelector("g\\:price, price")?.textContent?.trim() || "0";
        const price = parseFloat((priceRaw||"0").replace(/[^\d.]/g,"")) || 0;
        data.push({ title, link: pageUrl, image, price, slug });
      });
      return data;
    }

    function createCard(prod){
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.title = prod.title;

      const priceStr = currencySAR(prod.price);

      card.innerHTML = `
        <a href="${prod.link}" target="_blank" rel="noopener noreferrer" aria-label="فتح صفحة المنتج">
          <img data-src="${prod.image}" class="product-image lazy" alt="${prod.title.replace(/"/g,'&quot;')}">
        </a>
        <h2 class="title">${prod.title}</h2>
        <span class="price">${priceStr}</span>
        <a href="${prod.link}" target="_blank" rel="noopener noreferrer" class="shop-btn">تفاصيل المنتج</a>
        <div class="badge">شحن داخل السعودية</div>
      `;

      // صورة بديلة عند الفشل
      queueMicrotask(()=>{
        const img = card.querySelector("img");
        img.onerror = ()=>{ img.src = "https://via.placeholder.com/400x300?text=No+Image"; };
      });

      return card;
    }

    function renderEmpty(){
      const container = document.getElementById("products");
      container.innerHTML = '<p class="empty">لا توجد نتائج مطابقة.</p>';
    }

    function loadMoreItems(){
      const container = document.getElementById("products");
      const items = filteredData.slice(currentIndex, currentIndex + ITEMS_PER_LOAD);
      items.forEach(item => container.appendChild(createCard(item)));
      currentIndex += ITEMS_PER_LOAD;
      lazyLoadImages();
    }

    // بحث فوري
    const searchEl = document.getElementById("search");
    searchEl.addEventListener("input", function(){
      const val = this.value.toLowerCase();
      filteredData = productsData.filter(p => p.title.toLowerCase().includes(val));
      currentIndex = 0;
      const container = document.getElementById("products");
      container.innerHTML = "";
      if(filteredData.length === 0){ renderEmpty(); return; }
      loadMoreItems();
    });

    // تمرير لا متناهي
    window.addEventListener("scroll", ()=>{
      if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 140 && currentIndex < filteredData.length){
        loadMoreItems();
      }
    });

    // Lazy loading للصور
    function lazyLoadImages(){
      const imgs = document.querySelectorAll("img.lazy");
      const observer = new IntersectionObserver((entries, obs)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            entry.target.src = entry.target.dataset.src || "";
            entry.target.classList.remove("lazy");
            obs.unobserve(entry.target);
          }
        });
      }, { rootMargin:"0px 0px 200px 0px", threshold:0 });
      imgs.forEach(img => observer.observe(img));
    }

    // بدء التحميل
    async function loadProducts(){
      const container = document.getElementById("products");
      container.innerHTML = '<p class="loading-msg">جارٍ تحميل المنتجات...</p>';
      try{
        productsData = await fetchFeed();
        filteredData = [...productsData];
        currentIndex = 0;
        container.innerHTML = "";
        if(filteredData.length === 0){ renderEmpty(); return; }
        loadMoreItems();
      }catch(err){
        console.error(err);
        container.innerHTML = '<p class="loading-msg" style="color:#b91c1c">حدث خطأ في تحميل المنتجات. حاول لاحقاً.</p>';
      }
    }

    // تحسينات صغيرة للتجربة
    document.addEventListener("DOMContentLoaded", ()=>{
      // يحجز مساحة للهيدر المثبّت عند التنقّل للروابط الداخلية
      document.documentElement.style.scrollPaddingTop = "72px";
    });

    loadProducts();
  </script>
</body>
</html>
